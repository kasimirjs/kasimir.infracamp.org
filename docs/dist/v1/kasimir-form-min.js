/**
 * Infracamp's Kasimir Templates
 *
 * A no-dependency render on request
 *
 * @author Matthias Leuffen <m@tth.es>
 */
function ka_form(e){if(e instanceof KasimirForm)return e;let t=document.getElementById(e);if(null===t)throw`Selector '${e}' not found (no element mit id)`;if(t instanceof KasimirForm)return t;throw`Selector '${e}' is not a <form is="ka-form"> element`}class KasimirForm extends HTMLFormElement{constructor(){super(),this._data={},this.params={debounce:200},this._debounder=null,this._formEls=[],this.$event=null,this._skipSendChangeEvt=!1;this.addEventListener("submit",e=>{e.stopPropagation(),e.preventDefault()})}_updateElCon(){for(let e of this.querySelectorAll("input,select,textarea"))this._formEls.push(e),!0!==e._kasiFormI&&(e._kasiFormI=!0,e instanceof HTMLSelectElement||e instanceof HTMLInputElement&&"checkbox"===e.type?e.addEventListener("change",e=>{this._skipSendChangeEvt||(this.$event=e,this.dispatchEvent(new Event("change")))}):e.addEventListener("keyup",e=>{window.clearTimeout(this._debounder),"Enter"!==e.key&&(this._debounder=window.setTimeout(()=>{this.$event=e,this.dispatchEvent(new Event("change"))},this.params.debounce))}))}get $data(){let e={},t=e=>{switch(e.tagName){case"INPUT":switch(e.type){case"checkbox":case"radio":return 1==e.checked?e.value:null}case"SELECT":case"TEXTAREA":return e.value}};for(let i of this._formEls){if(""===i.name&&""===i.id)continue;let s=i.name;""===s&&(s=i.id),s.endsWith("[]")?(s=i.name.slice(0,-2),Array.isArray(e[s])||(e[s]=[]),e[s].push(t(i))):e[s]=t(i)}return this._data=e,e}set $data(e){this._skipSendChangeEvt=!0;let t=null,i={};this._data=e;for(let s of this._formEls){if(""===s.name&&""===s.id)continue;""===(t=s.name)&&(t=s.id);let n="";t.endsWith("[]")?(void 0===i[t=t.slice(0,-2)]&&(i[t]=0),n=e[t],Array.isArray(n)&&(n=n[i[t]++])):n=e[t],void 0===n&&(n=""),"INPUT"===s.tagName&&"checkbox"===s.type||"radio"===s.type?n===s.value?s.checked=!0:s.checked=!1:s.value=n}this._skipSendChangeEvt=!1}disconnectedCallback(){this._observer.disconnect()}connectedCallback(){if(this._observer=new MutationObserver(e=>{this._updateElCon()}),this._observer.observe(this,{childList:!0,subtree:!0}),this._updateElCon(),this.hasAttribute("init")){let code=this.getAttribute("init");try{eval(code)}catch(e){throw console.error(e,this),new Error(`eval("${code}") failed: ${e}`)}}}}customElements.define("ka-form",KasimirForm,{extends:"form"});class KasimirSelect extends HTMLSelectElement{constructor(){super(),this.__$options=[]}_updateOptions(){let e="value",t="text";this.hasAttribute("value_key")&&(e=this.getAttribute("value_key")),this.hasAttribute("text_key")&&(t=this.getAttribute("text_key")),this.innerHTML="";for(let i of this.__$options){let s=document.createElement("option");"object"==typeof i?(s.value=i[e],s.innerText=i[t]):(s.value=i,s.innerText=i),this.appendChild(s)}}connectedCallback(){let iniOptions=this.$options,value=this.$value;if(Object.defineProperty(this,"$options",{set:e=>{this.__$options=e,this._updateOptions()},get:e=>this.__$options}),Object.defineProperty(this,"$value",{set:e=>{this.value=e},get:e=>this.value}),void 0!==iniOptions&&(this.$options=iniOptions),void 0!==value&&(this.$value=value),this.hasAttribute("init")){let code=this.getAttribute("init");try{eval(code)}catch(e){throw console.error(e,this),new Error(`eval("${code}") failed: ${e}`)}}}}customElements.define("ka-select",KasimirSelect,{extends:"select"});